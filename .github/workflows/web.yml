name: Web CI

# Required CI Variables (GitHub Settings > Actions > Variables):
# - CI_ROLE_ARN: AWS IAM role ARN for OIDC authentication
# - AWS_REGION: AWS region for deployment (e.g., us-east-1)
# - AWS_S3_BUCKET: S3 bucket name for hosting the built assets

env:
  BUILD_OUTPUT_PATH: apps/web/dist/

defaults:
  run:
    working-directory: .

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/web/**'

  pull_request:
    branches: [ main ]
    paths:
      - 'apps/web/**'
      - '.github/workflows/*'

permissions:
  id-token: write  # Allows OIDC token requests
  contents: read   # Allows reading repo contents

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10.29.1

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: 24
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --filter web

    - name: Build application
      run: pnpm build --filter web

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: ${{ env.BUILD_OUTPUT_PATH }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: dev
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: ${{ env.BUILD_OUTPUT_PATH }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v6
      with:
        role-to-assume: ${{ vars.CI_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}

    - name: Debug AWS credentials
      run: |
        echo "AWS_ACCESS_KEY_ID is set: ${{ env.AWS_ACCESS_KEY_ID != '' && 'YES' || 'NO' }}"
        echo "AWS_SECRET_ACCESS_KEY is set: ${{ env.AWS_SECRET_ACCESS_KEY != '' && 'YES' || 'NO' }}"
        echo "AWS_SESSION_TOKEN is set: ${{ env.AWS_SESSION_TOKEN != '' && 'YES' || 'NO' }}"
        echo "AWS_REGION: ${{ env.AWS_REGION }}"
        echo "AWS_DEFAULT_REGION: ${{ env.AWS_DEFAULT_REGION }}"

    - name: Sync build to S3
      run: |
        aws s3 sync ${{ env.BUILD_OUTPUT_PATH }} s3://${{ vars.AWS_S3_BUCKET }}/build \
          --acl public-read \
          --follow-symlinks \
          --delete \
          --region ${{ vars.AWS_REGION }}